"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventExecutor = void 0;
const api_1 = require("@dedot/api");
const utils_1 = require("@dedot/utils");
const index_js_1 = require("./abstract/index.js");
class EventExecutor extends index_js_1.ContractExecutor {
    doExecute(eventName) {
        const meta = this.#findEventMeta(eventName);
        (0, utils_1.assert)(meta, 'Contract event metadata not found!');
        const is = (event) => {
            if ((0, api_1.isEventRecord)(event)) {
                try {
                    event = this.registry.decodeEvent(event, this.address);
                }
                catch {
                    return false;
                }
            }
            return event.name === eventName;
        };
        const find = (events) => {
            if (!events || events.length === 0)
                return undefined;
            if ((0, api_1.isEventRecord)(events[0])) {
                return this.registry.decodeEvents(events, this.address).find(is);
            }
            else {
                return events.find(is);
            }
        };
        const filter = (events) => {
            if ((0, api_1.isEventRecord)(events[0])) {
                return this.registry.decodeEvents(events, this.address).filter(is);
            }
            else {
                return events.filter(is);
            }
        };
        const watch = (callback) => {
            return this.client.query.system.events((records) => {
                const events = filter(records);
                if (events.length === 0)
                    return;
                callback(filter(records));
            });
        };
        return {
            is,
            find,
            filter,
            meta,
            watch,
        };
    }
    #findEventMeta(eventName) {
        return this.registry.metadata.spec.events.find((one) => (0, utils_1.stringPascalCase)(one.label) === eventName);
    }
}
exports.EventExecutor = EventExecutor;
